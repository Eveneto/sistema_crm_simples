import { render, screen, fireEvent } from '@testing-library/react';
import { Sidebar } from '../sidebar';

const mockUseUserRole = jest.fn();
const mockUsePathname = jest.fn();
const mockUseRouter = jest.fn();

// Mock do useUserRole
jest.mock('@/hooks/use-user-role', () => ({
  useUserRole: () => mockUseUserRole(),
}));

// Mock do Next.js navigation
jest.mock('next/navigation', () => ({
  usePathname: () => mockUsePathname(),
  useRouter: () => mockUseRouter(),
}));

describe('Sidebar', () => {
  beforeEach(() => {
    jest.clearAllMocks();
    mockUsePathname.mockReturnValue('/dashboard');
  });

  describe('Renderização - Admin', () => {
    beforeEach(() => {
      mockUseUserRole.mockReturnValue({
        role: 'admin',
        isAdmin: true,
        isManagerOrAdmin: true,
        isAgent: false,
        checkPermission: () => true,
      });
    });

    it('deve renderizar a sidebar', () => {
      render(<Sidebar />);

      expect(screen.getByRole('navigation')).toBeInTheDocument();
    });

    it('deve renderizar todos os itens de navegação para admin', () => {
      render(<Sidebar />);

      expect(screen.getByText('Dashboard')).toBeInTheDocument();
      expect(screen.getByText('Contatos')).toBeInTheDocument();
      expect(screen.getByText('Conversas')).toBeInTheDocument();
      expect(screen.getByText('Negócios')).toBeInTheDocument();
      expect(screen.getByText('Canais')).toBeInTheDocument();
      expect(screen.getByText('Usuários')).toBeInTheDocument();
      expect(screen.getByText('Relatórios')).toBeInTheDocument();
    });

    it('deve mostrar badge de Admin', () => {
      render(<Sidebar />);

      expect(screen.getByText('Administrador')).toBeInTheDocument();
    });
  });

  describe('Renderização - Manager', () => {
    beforeEach(() => {
      mockUseUserRole.mockReturnValue({
        role: 'manager',
        isAdmin: false,
        isManagerOrAdmin: true,
        isAgent: false,
        checkPermission: (permission: string) => {
          const managerPermissions = ['canViewReports', 'canManageStages'];
          return managerPermissions.includes(permission);
        },
      });
    });

    it('deve renderizar itens permitidos para manager', () => {
      render(<Sidebar />);

      expect(screen.getByText('Dashboard')).toBeInTheDocument();
      expect(screen.getByText('Contatos')).toBeInTheDocument();
      expect(screen.getByText('Conversas')).toBeInTheDocument();
      expect(screen.getByText('Negócios')).toBeInTheDocument();
      expect(screen.getByText('Relatórios')).toBeInTheDocument();
    });

    it('deve mostrar badge de Gerente', () => {
      render(<Sidebar />);

      expect(screen.getByText('Gerente')).toBeInTheDocument();
    });
  });

  describe('Renderização - Agent', () => {
    beforeEach(() => {
      mockUseUserRole.mockReturnValue({
        role: 'agent',
        isAdmin: false,
        isManagerOrAdmin: false,
        isAgent: true,
        checkPermission: () => false,
      });
    });

    it('deve renderizar apenas itens básicos para agent', () => {
      render(<Sidebar />);

      expect(screen.getByText('Dashboard')).toBeInTheDocument();
      expect(screen.getByText('Conversas')).toBeInTheDocument();
    });

    it('deve mostrar badge de Agente', () => {
      render(<Sidebar />);

      expect(screen.getByText('Agente')).toBeInTheDocument();
    });

    it('não deve mostrar itens administrativos', () => {
      render(<Sidebar />);

      expect(screen.queryByText('Usuários')).not.toBeInTheDocument();
      expect(screen.queryByText('Canais')).not.toBeInTheDocument();
      expect(screen.queryByText('Relatórios')).not.toBeInTheDocument();
    });
  });

  describe('Item Ativo', () => {
    beforeEach(() => {
      mockUseUserRole.mockReturnValue({
        role: 'admin',
        isAdmin: true,
        checkPermission: () => true,
      });
    });

    // TODO: Fix - testar classes CSS é frágil
    it.skip('deve destacar item ativo no dashboard', () => {
      mockUsePathname.mockReturnValue('/dashboard');
      render(<Sidebar />);

      const dashboardLink = screen.getByText('Dashboard').closest('a');
      expect(dashboardLink).toHaveClass('bg-primary');
    });

    // TODO: Fix - testar classes CSS é frágil
    it.skip('deve destacar item ativo em contatos', () => {
      mockUsePathname.mockReturnValue('/contacts');
      render(<Sidebar />);

      const contactsLink = screen.getByText('Contatos').closest('a');
      expect(contactsLink).toHaveClass('bg-primary');
    });
  });

  describe('Toggle Collapse', () => {
    beforeEach(() => {
      mockUseUserRole.mockReturnValue({
        role: 'admin',
        isAdmin: true,
        checkPermission: () => true,
      });
    });

    // TODO: Fix - botão de toggle não tem accessible name
    it.skip('deve ter botão de toggle', () => {
      render(<Sidebar />);

      const toggleButton = screen.getByRole('button', { name: /toggle/i });
      expect(toggleButton).toBeInTheDocument();
    });

    // TODO: Fix - botão de toggle não tem accessible name
    it.skip('deve alternar estado collapsed ao clicar no toggle', () => {
      render(<Sidebar />);

      const toggleButton = screen.getByRole('button', { name: /toggle/i });
      const sidebar = screen.getByRole('navigation');

      const initialWidth = sidebar.className;
      fireEvent.click(toggleButton);

      expect(sidebar.className).not.toBe(initialWidth);
    });
  });
});
