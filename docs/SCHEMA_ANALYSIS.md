# ğŸ” ANÃLISE DO SCHEMA vs ÃNDICES

## âœ… COLUNAS REAIS (do arquivo `001_initial_schema.sql`)

### ğŸ“‹ CONTACTS
- `id` âœ…
- `name` âœ… 
- `phone` âœ…
- `email` âœ…
- `avatar_url` âœ…
- `tags` (TEXT[]) âœ…
- `custom_fields` âœ…
- `created_by` (UUID) âš ï¸ **NÃƒO Ã‰ user_id**
- `created_at` âœ…
- `updated_at` âœ…

### ğŸ“‹ CONVERSATIONS
- `id` âœ…
- `contact_id` âœ…
- `channel_id` âœ…
- `assigned_to` (UUID) âœ…
- `status` âœ…
- `last_message_at` âœ…
- `unread_count` âœ…
- `created_at` âœ…
- `updated_at` âœ…

### ğŸ“‹ MESSAGES
- `id` âœ…
- `conversation_id` âœ…
- `sender_type` âœ… (user, contact)
- `sender_id` (UUID) âš ï¸ **NÃƒO Ã‰ coluna de tipo especÃ­fico**
- `content` âœ…
- `media_url` âœ…
- `message_type` âœ…
- `whatsapp_message_id` âœ…
- `is_read` âœ…
- `created_at` âœ…

### ğŸ“‹ DEALS
- `id` âœ…
- `title` âœ…
- `description` âœ…
- `contact_id` âœ…
- `stage_id` âœ…
- `value` âœ…
- `expected_close_date` âœ…
- `assigned_to` (UUID) âœ…
- `position` âœ…
- `status` âœ…
- `created_at` âœ…
- `updated_at` âœ…

## ğŸš¨ ERROS NO SQL ORIGINAL

### âŒ CONTACTS
| Ãndice | Problema | SoluÃ§Ã£o |
|--------|----------|---------|
| `idx_contacts_user_id` | **Coluna nÃ£o existe!** Usar `created_by` | Renomear ou remover |
| `idx_contacts_name` | OK (coluna existe) | âœ… Deixar como estÃ¡ |
| `idx_contacts_email` | OK (coluna existe) | âœ… Deixar como estÃ¡ |

### âŒ CONVERSATIONS
| Ãndice | Problema | SoluÃ§Ã£o |
|--------|----------|---------|
| `idx_conversations_assigned_to` | âš ï¸ JÃ¡ existe no schema! | âœ… Remover (jÃ¡ feito) |
| `idx_conversations_contact_id` | âš ï¸ JÃ¡ existe! Aqui Ã© `idx_conversations_contact` | âœ… Remover ou deixar |
| `idx_conversations_status` | âš ï¸ JÃ¡ existe! | âœ… Remover (jÃ¡ feito) |
| `idx_conversations_last_message_at` | âš ï¸ JÃ¡ existe! Aqui Ã© `idx_conversations_last_message` | âœ… Remover |

### âŒ MESSAGES
| Ãndice | Problema | SoluÃ§Ã£o |
|--------|----------|---------|
| `idx_messages_conversation_id` | âš ï¸ JÃ¡ existe! Aqui Ã© `idx_messages_conversation` | âœ… Remover |
| `idx_messages_created_at` | âš ï¸ JÃ¡ existe! Aqui Ã© `idx_messages_created` | âœ… Remover |
| `idx_messages_conversation_created_at` | âœ… OK (composite) | âœ… Deixar |
| `idx_messages_sender_id` | **Coluna existe (`sender_id` Ã© UUID)** | âœ… Deixar |

### âŒ DEALS
| Ãndice | Problema | SoluÃ§Ã£o |
|--------|----------|---------|
| `idx_deals_user_id` | **Coluna nÃ£o existe!** Usar `assigned_to` | Renomear |
| `idx_deals_stage_id` | âš ï¸ JÃ¡ existe! Aqui Ã© `idx_deals_stage` | âœ… Remover |
| `idx_deals_contact_id` | âš ï¸ JÃ¡ existe! Aqui Ã© `idx_deals_contact` | âœ… Remover |
| `idx_deals_status` | âš ï¸ JÃ¡ existe! | âœ… Remover |

## âœ¨ CONCLUSÃƒO

**Ãndices que PRECISAM ser criados:**
1. âœ… `idx_contacts_name` (GIN full-text) - NECESSÃRIO
2. âœ… `idx_messages_conversation_created_at` (composite) - NOVO e Ãºtil
3. âœ… `idx_messages_sender_id` - OK

**Ãndices que PRECISAM ser ajustados:**
1. âš ï¸ `idx_contacts_user_id` â†’ remover (nÃ£o serÃ¡ usado)
2. âš ï¸ `idx_deals_user_id` â†’ `idx_deals_assigned_to` (ajustar)

**Ãndices que DUPLICAM schema:**
- Todas as outras (jÃ¡ existem no `001_initial_schema.sql`)

## ğŸ¯ RECOMENDAÃ‡ÃƒO

Usar `indices.sql` APENAS para:
- `idx_contacts_name` (GIN trgm - nÃ£o estÃ¡ no schema original!)
- `idx_messages_conversation_created_at` (composite - nÃ£o estÃ¡!)
- `idx_messages_sender_id` (para filtrar por sender)

Todas as outras JÃ EXISTEM no banco!

